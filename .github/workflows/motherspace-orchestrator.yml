name: MotherSpace Orchestrator

on:
  issues:
    types: [opened, edited, labeled, unlabeled]
  pull_request:
    types: [opened, edited, synchronize, labeled, unlabeled]
  workflow_run:
    workflows: ["CI", "Test Failure Issue Automation", "Space Management Automation"]
    types: [completed]
  schedule:
    # MotherSpace harmony check every 2 hours during work hours
    - cron: "0 */2 * * 1-5"
  workflow_dispatch:
    inputs:
      operation:
        description: 'MotherSpace operation to perform'
        required: true
        default: 'harmony_check'
        type: choice
        options:
        - harmony_check
        - task_delegation
        - space_optimization
        - full_analysis

jobs:
  motherspace_orchestrator:
    runs-on: ubuntu-latest
    # Concurrency control to prevent multiple instances
    concurrency:
      group: motherspace-orchestrator
      cancel-in-progress: false
    permissions:
      issues: write
      pull-requests: write
      contents: read
      actions: read
      repository-projects: write
    env:
      MOTHERSPACE_VERSION: "1.2.0"  # Updated for safety features
      HARMONY_THRESHOLD: "85"
      SECURITY_LEVEL: "high"
      SAFETY_MODE: "enabled"
      QUIET_MODE: "true"
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 50  # Deep history for pattern analysis
      
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install MotherSpace dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyYAML requests jsonschema python-dateutil
      
      - name: Initialize MotherSpace Safety System
        id: safety_init
        run: |
          echo "üõ°Ô∏è Initializing MotherSpace Safety System..."
          
          # Create safety directory if it doesn't exist
          mkdir -p .github/motherspace-safety
          
          # Test safety system
          python scripts/motherspace_safety.py --test
          
          # Check if we're safe to proceed
          python scripts/motherspace_safety.py --check "orchestrator_run" --actor "${{ github.actor || 'github-actions' }}"
          
          echo "safety_initialized=true" >> $GITHUB_OUTPUT
      
      - name: MotherSpace Initialization and Context Analysis
        id: motherspace_init
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            console.log('üéØ MotherSpace Orchestrator v${{ env.MOTHERSPACE_VERSION }} Initializing...');
            
            // Analyze current system state
            const systemState = {
              timestamp: new Date().toISOString(),
              trigger: context.eventName,
              operation: '${{ github.event.inputs.operation }}' || 'auto',
              repository: {
                owner: context.repo.owner,
                repo: context.repo.repo,
                default_branch: context.payload.repository?.default_branch || 'main'
              },
              spaces: {
                motherspace: { active: true, version: '${{ env.MOTHERSPACE_VERSION }}' },
                daughter: { active: false, status: 'initializing' },
                integration_manager: { active: false, status: 'initializing' }
              },
              harmony_threshold: parseInt('${{ env.HARMONY_THRESHOLD }}'),
              security_level: '${{ env.SECURITY_LEVEL }}'
            };
            
            // Scan for existing spaces and their health
            const spaceFiles = [
              '.github/copilot-instructions.md',
              '.github/workflows/space-management.yml',
              '.github/workflows/test-failure-automation.yml',
              'docs/SPACE_OVERVIEW.md',
              'docs/ARCHITECTURE.md'
            ];
            
            for (const spaceFile of spaceFiles) {
              try {
                const content = fs.readFileSync(spaceFile, 'utf8');
                const stats = fs.statSync(spaceFile);
                systemState.spaces[spaceFile] = {
                  exists: true,
                  size: stats.size,
                  lastModified: stats.mtime,
                  health: content.length > 1000 ? 'good' : 'needs_attention'
                };
              } catch (error) {
                systemState.spaces[spaceFile] = { exists: false, health: 'missing' };
              }
            }
            
            // Analyze active issues and PRs for task delegation opportunities
            const [issues, pulls] = await Promise.all([
              github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                per_page: 100
              }),
              github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                per_page: 50
              })
            ]);
            
            systemState.active_work = {
              open_issues: issues.data.length,
              open_prs: pulls.data.length,
              issues_by_type: {},
              prs_by_type: {},
              delegation_candidates: []
            };
            
            // Categorize issues for delegation
            for (const issue of issues.data) {
              const labels = issue.labels.map(l => l.name);
              const type = labels.find(l => ['bug', 'enhancement', 'feature', 'maintenance', 'ui-ux', 'integration'].includes(l)) || 'uncategorized';
              
              systemState.active_work.issues_by_type[type] = (systemState.active_work.issues_by_type[type] || 0) + 1;
              
              // Identify delegation candidates
              if (labels.includes('needs-triage') || labels.includes('help wanted') || 
                  issue.title.toLowerCase().includes('ui') || issue.title.toLowerCase().includes('integration')) {
                systemState.active_work.delegation_candidates.push({
                  number: issue.number,
                  title: issue.title,
                  labels: labels,
                  suggested_space: labels.includes('ui-ux') ? 'daughter' : 
                                 labels.includes('integration') ? 'integration_manager' : 'motherspace'
                });
              }
            }
            
            // Calculate system harmony score
            const harmony_factors = {
              space_health: Object.values(systemState.spaces).filter(s => s.health === 'good').length / Object.keys(systemState.spaces).length,
              issue_balance: Math.min(systemState.active_work.open_issues / 20, 1), // Optimal: 20 or fewer open issues
              pr_freshness: Math.min(systemState.active_work.open_prs / 10, 1), // Optimal: 10 or fewer open PRs
              delegation_efficiency: systemState.active_work.delegation_candidates.length / Math.max(systemState.active_work.open_issues, 1)
            };
            
            const harmony_score = Math.round(
              (harmony_factors.space_health * 0.3 + 
               (1 - harmony_factors.issue_balance) * 0.25 +
               (1 - harmony_factors.pr_freshness) * 0.25 +
               harmony_factors.delegation_efficiency * 0.2) * 100
            );
            
            systemState.harmony_score = harmony_score;
            systemState.harmony_factors = harmony_factors;
            systemState.needs_intervention = harmony_score < parseInt('${{ env.HARMONY_THRESHOLD }}');
            
            core.setOutput('system_state', JSON.stringify(systemState));
            core.setOutput('harmony_score', harmony_score);
            core.setOutput('needs_intervention', systemState.needs_intervention);
            
            console.log(`üéØ System Harmony Score: ${harmony_score}%`);
            console.log(`üîÑ Delegation Candidates: ${systemState.active_work.delegation_candidates.length}`);
            
            return systemState;

      - name: Automated Issue Analysis and Management
        id: issue_management
        if: ${{ steps.safety_init.outputs.safety_initialized == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const systemState = JSON.parse('${{ steps.motherspace_init.outputs.system_state }}');
            
            console.log('üîç MotherSpace analyzing automated issues with safety features...');
            
            // Import safety manager functions
            const fs = require('fs');
            const crypto = require('crypto');
            
            // Fingerprint generation function (simplified version)
            function generateIssueFingerprint(issue) {
              const title = (issue.title || '').toLowerCase().trim();
              const body = (issue.body || '').toLowerCase().trim();
              const labels = (issue.labels || []).map(l => l.name).sort();
              
              // Normalize text (remove timestamps, issue refs, etc.)
              const normalizedTitle = title
                .replace(/\d{4}-\d{2}-\d{2}[T\s]\d{2}:\d{2}:\d{2}/g, '[TIMESTAMP]')
                .replace(/#\d+/g, '[ISSUE_REF]')
                .replace(/\s+/g, ' ');
              
              const normalizedBody = body
                .replace(/\d{4}-\d{2}-\d{2}[T\s]\d{2}:\d{2}:\d{2}/g, '[TIMESTAMP]')
                .replace(/#\d+/g, '[ISSUE_REF]')
                .replace(/\b[a-f0-9]{8,}\b/g, '[HASH]')
                .replace(/\s+/g, ' ');
              
              const fingerprintData = {
                title: normalizedTitle,
                body_hash: crypto.createHash('sha256').update(normalizedBody).digest('hex').substring(0, 16),
                labels: labels,
                type: classifyIssueType(issue)
              };
              
              const salt = 'motherspace-orchestrator-v1.2.0';
              const fingerprintString = JSON.stringify(fingerprintData);
              return crypto.createHash('sha256').update(`${salt}:${fingerprintString}`).digest('hex').substring(0, 16);
            }
            
            function classifyIssueType(issue) {
              const title = (issue.title || '').toLowerCase();
              const labels = (issue.labels || []).map(l => l.name);
              
              if (labels.includes('bug') || labels.includes('error') || title.includes('bug') || title.includes('error')) return 'bug';
              if (labels.includes('enhancement') || labels.includes('feature') || title.includes('feature')) return 'enhancement';
              if (labels.includes('maintenance') || title.includes('update') || title.includes('maintain')) return 'maintenance';
              if (labels.includes('automated') || labels.includes('motherspace') || title.includes('automated')) return 'automated';
              return 'general';
            }
            
            // Load existing tracking issues
            let trackingIssues = {};
            try {
              const trackingFile = '.github/motherspace-safety/tracking_issues.json';
              if (fs.existsSync(trackingFile)) {
                const trackingData = JSON.parse(fs.readFileSync(trackingFile, 'utf8'));
                trackingIssues = trackingData.fingerprints || {};
              }
            } catch (error) {
              console.log('‚ÑπÔ∏è No existing tracking issues file, starting fresh');
            }
            
            // Get all open issues with automated labels
            const allIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            
            // Filter automated issues
            const automatedIssues = allIssues.data.filter(issue => {
              const labels = issue.labels.map(l => l.name);
              return labels.some(label => 
                ['automated', 'test-failure', 'motherspace', 'daughter', 'integration-manager', 
                 'ci-generated', 'validation-report', 'security-alert'].includes(label)
              ) || issue.title.includes('üö®') || issue.title.includes('üéØ') || issue.title.includes('üë©‚Äçüíª');
            });
            
            console.log(`Found ${automatedIssues.length} automated issues for analysis`);
            
            const analysisResults = {
              fingerprints_generated: {},
              duplicates_found: [],
              tracking_issues_updated: [],
              new_tracking_issues: [],
              spam_prevented: [],
              errors: []
            };
            
            // Generate fingerprints and check for duplicates/tracking
            const fingerprintGroups = {};
            
            for (const issue of automatedIssues) {
              try {
                const fingerprint = generateIssueFingerprint(issue);
                analysisResults.fingerprints_generated[issue.number] = fingerprint;
                
                if (!fingerprintGroups[fingerprint]) {
                  fingerprintGroups[fingerprint] = [];
                }
                fingerprintGroups[fingerprint].push(issue);
                
                // Check if this fingerprint has an existing tracking issue
                if (trackingIssues[fingerprint]) {
                  const trackingIssue = trackingIssues[fingerprint];
                  console.log(`üîç Issue #${issue.number} matches existing tracking issue #${trackingIssue.issue_number}`);
                  analysisResults.tracking_issues_updated.push({
                    existing_issue: trackingIssue.issue_number,
                    duplicate_issue: issue.number,
                    fingerprint: fingerprint
                  });
                }
              } catch (error) {
                analysisResults.errors.push(`Failed to process issue #${issue.number}: ${error.message}`);
              }
            }
            
            // Identify duplicate groups (fingerprints with multiple issues)
            for (const [fingerprint, issues] of Object.entries(fingerprintGroups)) {
              if (issues.length > 1) {
                // Sort by creation date (keep newest)
                issues.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                const newest = issues[0];
                const duplicates = issues.slice(1);
                
                analysisResults.duplicates_found.push({
                  fingerprint: fingerprint,
                  newest_issue: newest.number,
                  duplicate_issues: duplicates.map(d => d.number),
                  can_close_duplicates: duplicates.length <= 3  // Safety limit
                });
              }
            }
            
            // Check for PR interference
            const openPRs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            
            // Filter operations that are safe (don't interfere with PRs)
            const safeOperations = analysisResults.duplicates_found.filter(group => {
              return group.duplicate_issues.every(issueNum => {
                const issueRef = `#${issueNum}`;
                return !openPRs.data.some(pr => 
                  (pr.body && pr.body.includes(issueRef)) || 
                  pr.title.toLowerCase().includes(issueNum.toString())
                );
              });
            });
            
            console.log(`üìä Analysis Results:`);
            console.log(`   Fingerprints generated: ${Object.keys(analysisResults.fingerprints_generated).length}`);
            console.log(`   Duplicate groups found: ${analysisResults.duplicates_found.length}`);
            console.log(`   Safe operations: ${safeOperations.length}`);
            console.log(`   Tracking issues to update: ${analysisResults.tracking_issues_updated.length}`);
            
            // Update analysis results with safe operations
            analysisResults.safe_operations = safeOperations;
            
            core.setOutput('issue_analysis', JSON.stringify(analysisResults));
            
            return analysisResults;

      - name: Execute Safe Issue Management Operations
        id: execute_operations
        if: ${{ fromJSON(steps.issue_management.outputs.issue_analysis).safe_operations && steps.safety_init.outputs.safety_initialized == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const analysisResults = JSON.parse('${{ steps.issue_management.outputs.issue_analysis }}');
            const systemState = JSON.parse('${{ steps.motherspace_init.outputs.system_state }}');
            
            console.log('üîß MotherSpace executing safe, idempotent issue management...');
            
            const operationResults = {
              tracking_issues_created: [],
              tracking_issues_updated: [],
              duplicates_managed: [],
              spam_prevented: [],
              errors: []
            };
            
            const fs = require('fs');
            
            // Load or create tracking issues registry
            let trackingRegistry = {};
            const trackingFile = '.github/motherspace-safety/tracking_issues.json';
            try {
              if (fs.existsSync(trackingFile)) {
                const trackingData = JSON.parse(fs.readFileSync(trackingFile, 'utf8'));
                trackingRegistry = trackingData.fingerprints || {};
              }
            } catch (error) {
              console.log('‚ÑπÔ∏è Creating new tracking issues registry');
              trackingRegistry = {};
            }
            
            // Process tracking issue updates (create-or-update pattern)
            for (const update of analysisResults.tracking_issues_updated || []) {
              try {
                const existingIssue = update.existing_issue;
                const duplicateIssue = update.duplicate_issue;
                
                // Update existing tracking issue instead of creating new one
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue,
                  body: [
                    `## üîÑ MotherSpace Tracking Update`,
                    ``,
                    `**Update Time:** ${new Date().toISOString()}`,
                    `**Duplicate Detected:** #${duplicateIssue}`,
                    `**Fingerprint:** \`${update.fingerprint}\``,
                    ``,
                    `This tracking issue has been updated to include a newly detected duplicate issue. The duplicate issue will be closed to maintain repository organization.`,
                    ``,
                    `**Safety Verified:** ‚úÖ No PR interference detected`,
                    `**Action:** Consolidating duplicate under this tracking issue`,
                    ``,
                    `---`,
                    `*Updated by MotherSpace Orchestrator v${{ env.MOTHERSPACE_VERSION }} (Quiet Mode)*`
                  ].join('\n')
                });
                
                // Close the duplicate issue quietly
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: duplicateIssue,
                  state: 'closed',
                  labels: ['duplicate', 'motherspace-managed', 'consolidated']
                });
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: duplicateIssue,
                  body: [
                    `## üéØ MotherSpace Consolidation`,
                    ``,
                    `This issue has been consolidated under tracking issue #${existingIssue}.`,
                    ``,
                    `**Reason:** Duplicate detected via fingerprint analysis`,
                    `**Tracking Issue:** #${existingIssue}`,
                    `**Action:** Automatically closed for organization`,
                    ``,
                    `---`,
                    `*Managed by MotherSpace Orchestrator v${{ env.MOTHERSPACE_VERSION }}*`
                  ].join('\n')
                });
                
                operationResults.tracking_issues_updated.push({
                  tracking_issue: existingIssue,
                  duplicate_closed: duplicateIssue,
                  fingerprint: update.fingerprint
                });
                
                console.log(`üîÑ Updated tracking issue #${existingIssue}, closed duplicate #${duplicateIssue}`);
              } catch (error) {
                operationResults.errors.push(`Failed to update tracking issue ${update.existing_issue}: ${error.message}`);
              }
            }
            
            // Process safe duplicate removal operations (limited and careful)
            const maxOperationsPerRun = 3; // Safety limit
            const safeOperations = (analysisResults.safe_operations || []).slice(0, maxOperationsPerRun);
            
            for (const duplicateGroup of safeOperations) {
              try {
                if (!duplicateGroup.can_close_duplicates) {
                  console.log(`‚ö†Ô∏è Skipping duplicate group with fingerprint ${duplicateGroup.fingerprint} (safety limit exceeded)`);
                  continue;
                }
                
                const newestIssue = duplicateGroup.newest_issue;
                const duplicateIssues = duplicateGroup.duplicate_issues;
                
                // Check if we have a tracking issue for this fingerprint
                let trackingIssueNumber = trackingRegistry[duplicateGroup.fingerprint]?.issue_number;
                
                if (!trackingIssueNumber) {
                  // Create new tracking issue for this fingerprint
                  const trackingTitle = `üéØ MotherSpace Tracking - ${duplicateGroup.fingerprint.substring(0, 8)}`;
                  const trackingBody = [
                    `# MotherSpace Issue Tracking`,
                    ``,
                    `**Tracking ID:** \`${duplicateGroup.fingerprint}\``,
                    `**Created:** ${new Date().toISOString()}`,
                    `**Primary Issue:** #${newestIssue}`,
                    `**Consolidated Issues:** ${duplicateIssues.length > 0 ? duplicateIssues.map(n => `#${n}`).join(', ') : 'None'}`,
                    ``,
                    `## Purpose`,
                    `This tracking issue consolidates multiple similar automated issues to reduce repository noise while preserving all information and requirements.`,
                    ``,
                    `## Fingerprint Analysis`,
                    `All issues under this tracking have the same fingerprint: \`${duplicateGroup.fingerprint}\``,
                    ``,
                    `This means they represent the same underlying issue or pattern and can be safely consolidated.`,
                    ``,
                    `## Actions Taken`,
                    duplicateIssues.length > 0 ? [
                      `- Identified ${duplicateIssues.length} duplicate issues`,
                      `- Consolidated all duplicates under this tracking issue`,
                      `- Preserved all original information and requirements`,
                      `- Applied safety checks to prevent PR interference`
                    ].join('\n') : '- No duplicates found at this time',
                    ``,
                    `## Quality Assurance`,
                    `- ‚úÖ Safety checks passed`,
                    `- ‚úÖ No PR interference detected`,
                    `- ‚úÖ All requirements preserved`,
                    `- ‚úÖ Repository organization improved`,
                    ``,
                    `---`,
                    `*This is a MotherSpace tracking issue. It consolidates similar issues without losing information.*`,
                    `*Created by MotherSpace Orchestrator v${{ env.MOTHERSPACE_VERSION }}*`
                  ].join('\n');
                  
                  const trackingIssue = await github.rest.issues.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: trackingTitle,
                    body: trackingBody,
                    labels: ['motherspace-tracking', 'automated', 'consolidation'],
                    assignees: ['HANSKMIEL']
                  });
                  
                  trackingIssueNumber = trackingIssue.data.number;
                  
                  // Register in tracking registry
                  trackingRegistry[duplicateGroup.fingerprint] = {
                    issue_number: trackingIssueNumber,
                    title: trackingTitle,
                    created_at: new Date().toISOString(),
                    last_updated: new Date().toISOString(),
                    update_count: 1,
                    consolidated_issues: [newestIssue, ...duplicateIssues]
                  };
                  
                  operationResults.tracking_issues_created.push({
                    tracking_issue: trackingIssueNumber,
                    fingerprint: duplicateGroup.fingerprint,
                    primary_issue: newestIssue,
                    duplicates: duplicateIssues
                  });
                  
                  console.log(`üìù Created tracking issue #${trackingIssueNumber} for fingerprint ${duplicateGroup.fingerprint.substring(0, 8)}`);
                }
                
                // Close duplicate issues and reference tracking issue
                for (const duplicateIssue of duplicateIssues) {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: duplicateIssue,
                    body: [
                      `## üéØ MotherSpace Consolidation`,
                      ``,
                      `This issue has been consolidated under tracking issue #${trackingIssueNumber}.`,
                      ``,
                      `**Reason:** Identified as duplicate via fingerprint analysis`,
                      `**Tracking Issue:** #${trackingIssueNumber}`,
                      `**Primary Issue:** #${newestIssue}`,
                      `**Fingerprint:** \`${duplicateGroup.fingerprint}\``,
                      ``,
                      `All information and requirements from this issue are preserved in the tracking issue.`,
                      ``,
                      `---`,
                      `*Consolidation by MotherSpace Orchestrator v${{ env.MOTHERSPACE_VERSION }}*`
                    ].join('\n')
                  });
                  
                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: duplicateIssue,
                    state: 'closed',
                    labels: ['duplicate', 'motherspace-managed', 'consolidated']
                  });
                }
                
                operationResults.duplicates_managed.push({
                  tracking_issue: trackingIssueNumber,
                  primary_issue: newestIssue,
                  duplicates_closed: duplicateIssues,
                  fingerprint: duplicateGroup.fingerprint
                });
                
                console.log(`üîÑ Managed ${duplicateIssues.length} duplicates under tracking issue #${trackingIssueNumber}`);
              } catch (error) {
                operationResults.errors.push(`Failed to manage duplicate group: ${error.message}`);
              }
            }
            
            // Save updated tracking registry
            try {
              const updatedTrackingData = {
                last_updated: new Date().toISOString(),
                version: '${{ env.MOTHERSPACE_VERSION }}',
                fingerprints: trackingRegistry
              };
              
              fs.writeFileSync(trackingFile, JSON.stringify(updatedTrackingData, null, 2));
              console.log(`üíæ Updated tracking registry with ${Object.keys(trackingRegistry).length} fingerprints`);
            } catch (error) {
              operationResults.errors.push(`Failed to save tracking registry: ${error.message}`);
            }
            
            core.setOutput('operation_results', JSON.stringify(operationResults));
            
            console.log(`üéØ Safe Issue Management Complete:`);
            console.log(`   Tracking issues created: ${operationResults.tracking_issues_created.length}`);
            console.log(`   Tracking issues updated: ${operationResults.tracking_issues_updated.length}`);
            console.log(`   Duplicates managed: ${operationResults.duplicates_managed.length}`);
            console.log(`   Errors: ${operationResults.errors.length}`);
            
            return operationResults;

      - name: Space Health Assessment and Optimization
        id: space_assessment
        if: ${{ fromJSON(steps.motherspace_init.outputs.system_state).needs_intervention || github.event.inputs.operation == 'space_optimization' }}
        uses: actions/github-script@v7
        with:
          script: |
            const systemState = JSON.parse('${{ steps.motherspace_init.outputs.system_state }}');
            
            console.log('üîç Performing deep space health assessment...');
            
            const optimizationPlan = {
              immediate_actions: [],
              daughter_tasks: [],
              integration_manager_tasks: [],
              space_updates: []
            };
            
            // Analyze Copilot Space health
            if (!systemState.spaces['.github/copilot-instructions.md']?.exists) {
              optimizationPlan.immediate_actions.push({
                priority: 'critical',
                action: 'create_copilot_instructions',
                description: 'Create comprehensive Copilot instructions for MotherSpace system'
              });
            }
            
            // Check for UI/UX issues that need Daughter space attention
            for (const candidate of systemState.active_work.delegation_candidates) {
              if (candidate.suggested_space === 'daughter') {
                optimizationPlan.daughter_tasks.push({
                  issue_number: candidate.number,
                  title: candidate.title,
                  analysis_type: 'ui_ux_optimization',
                  priority: candidate.labels.includes('priority-high') ? 'high' : 'medium'
                });
              } else if (candidate.suggested_space === 'integration_manager') {
                optimizationPlan.integration_manager_tasks.push({
                  issue_number: candidate.number,
                  title: candidate.title,
                  integration_type: 'external_system',
                  priority: candidate.labels.includes('priority-high') ? 'high' : 'medium'
                });
              }
            }
            
            // Space documentation updates needed
            if (systemState.harmony_score < 90) {
              optimizationPlan.space_updates.push({
                file: '.github/copilot-instructions.md',
                update_type: 'motherspace_patterns',
                reason: 'Add MotherSpace orchestration patterns'
              });
            }
            
            core.setOutput('optimization_plan', JSON.stringify(optimizationPlan));
            
            console.log(`üìã Optimization Plan Generated:`);
            console.log(`   Immediate Actions: ${optimizationPlan.immediate_actions.length}`);
            console.log(`   Daughter Tasks: ${optimizationPlan.daughter_tasks.length}`);
            console.log(`   Integration Tasks: ${optimizationPlan.integration_manager_tasks.length}`);
            
            return optimizationPlan;

      - name: Task Delegation and Chronological Planning
        id: task_delegation
        if: ${{ steps.space_assessment.outputs.optimization_plan && fromJSON(steps.space_assessment.outputs.optimization_plan).immediate_actions }}
        uses: actions/github-script@v7
        with:
          script: |
            const optimizationPlan = JSON.parse('${{ steps.space_assessment.outputs.optimization_plan }}');
            const systemState = JSON.parse('${{ steps.motherspace_init.outputs.system_state }}');
            
            console.log('üéØ MotherSpace initiating task delegation...');
            
            // Create chronological development order
            const taskSequence = [];
            
            // Phase 1: Critical infrastructure
            optimizationPlan.immediate_actions
              .filter(action => action.priority === 'critical')
              .forEach((action, index) => {
                taskSequence.push({
                  phase: 1,
                  order: index + 1,
                  space: 'motherspace',
                  task: action,
                  dependencies: [],
                  estimated_duration: '2-4 hours'
                });
              });
            
            // Phase 2: Daughter space UI/UX tasks
            optimizationPlan.daughter_tasks.forEach((task, index) => {
              taskSequence.push({
                phase: 2,
                order: index + 1,
                space: 'daughter',
                task: task,
                dependencies: taskSequence.filter(t => t.phase === 1).map(t => `Phase-1-Task-${t.order}`),
                estimated_duration: '4-8 hours'
              });
            });
            
            // Phase 3: Integration manager tasks
            optimizationPlan.integration_manager_tasks.forEach((task, index) => {
              taskSequence.push({
                phase: 3,
                order: index + 1,
                space: 'integration_manager',
                task: task,
                dependencies: [], // Can run in parallel with daughter tasks
                estimated_duration: '6-12 hours'
              });
            });
            
            // Create comprehensive delegation issue
            if (taskSequence.length > 0) {
              const title = `üéØ MotherSpace Task Delegation - ${taskSequence.length} Tasks Queued`;
              const body = [
                `# MotherSpace Orchestrated Task Delegation`,
                ``,
                `**Orchestration Time:** ${new Date().toISOString()}`,
                `**Harmony Score:** ${systemState.harmony_score}% (Target: ‚â•${systemState.harmony_threshold}%)`,
                `**Security Level:** ${systemState.security_level.toUpperCase()}`,
                `**Total Tasks:** ${taskSequence.length}`,
                ``,
                `## üéØ MotherSpace Analysis`,
                `The MotherSpace has analyzed the current system state and identified tasks requiring coordinated execution across multiple spaces. Each task has been prioritized and sequenced for optimal development flow with quality and security checks in place.`,
                ``,
                `## üìã Chronological Task Sequence`,
                ``,
                ...taskSequence.map(task => [
                  `### Phase ${task.phase} - Task ${task.order} (${task.space.toUpperCase()})`,
                  `**Space:** ${task.space}`,
                  `**Duration:** ${task.estimated_duration}`,
                  `**Dependencies:** ${task.dependencies.length > 0 ? task.dependencies.join(', ') : 'None'}`,
                  ``,
                  `**Task Details:**`,
                  task.space === 'daughter' ? [
                    `- **Issue:** #${task.task.issue_number} - ${task.task.title}`,
                    `- **Analysis Type:** ${task.task.analysis_type}`,
                    `- **Priority:** ${task.task.priority}`,
                    `- **Daughter Focus:** UI/UX optimization, user workflow analysis, visual appeal enhancement`
                  ].join('\n') : 
                  task.space === 'integration_manager' ? [
                    `- **Issue:** #${task.task.issue_number} - ${task.task.title}`,
                    `- **Integration Type:** ${task.task.integration_type}`,
                    `- **Priority:** ${task.task.priority}`,
                    `- **Manager Focus:** External system integration, module development, API connections`
                  ].join('\n') : [
                    `- **Action:** ${task.task.action}`,
                    `- **Description:** ${task.task.description}`,
                    `- **Priority:** ${task.task.priority}`,
                    `- **MotherSpace Focus:** System orchestration, space coordination, quality assurance`
                  ].join('\n'),
                  ``,
                  `- [ ] Task ready for execution`,
                  `- [ ] Dependencies verified`,
                  `- [ ] Quality checks passed`,
                  `- [ ] Security validation completed`,
                  `- [ ] Task execution completed`,
                  `- [ ] Results integrated`,
                  ``,
                ]).flat(),
                `## üîÑ Cross-Space Communication Protocol`,
                ``,
                `**Daughter ‚Üí MotherSpace Reporting:**`,
                `- All UI/UX analysis results reported in comments on this issue`,
                `- Visual appeal recommendations with screenshots/mockups`,
                `- User workflow optimization suggestions`,
                `- Integration error reports labeled "Daughter-Integration Manager [Date Time]"`,
                ``,
                `**IntegrationManager ‚Üí MotherSpace Reporting:**`,
                `- Module development progress updates`,
                `- External system integration status`,
                `- API connection results and recommendations`,
                `- Cross-profession adaptability analysis`,
                ``,
                `**MotherSpace Coordination:**`,
                `- Monitors all space activities for harmony`,
                `- Resolves conflicts between spaces`,
                `- Ensures chronological task execution`,
                `- Maintains quality and security standards`,
                ``,
                `## üõ°Ô∏è Quality and Security Checkpoints`,
                ``,
                `Each task must pass these checkpoints before proceeding:`,
                ``,
                `### Phase 1 Checkpoints (MotherSpace):`,
                `- [ ] Code quality standards maintained`,
                `- [ ] Security vulnerabilities addressed`,
                `- [ ] Documentation updated`,
                `- [ ] Space coordination verified`,
                ``,
                `### Phase 2 Checkpoints (Daughter):`,
                `- [ ] UI/UX improvements validated`,
                `- [ ] User workflow optimizations tested`,
                `- [ ] Visual appeal enhancements verified`,
                `- [ ] Integration requirements documented`,
                ``,
                `### Phase 3 Checkpoints (IntegrationManager):`,
                `- [ ] Module functionality verified`,
                `- [ ] External integrations tested`,
                `- [ ] API connections validated`,
                `- [ ] Cross-profession compatibility confirmed`,
                ``,
                `## üìä Success Metrics`,
                ``,
                `**Target Outcomes:**`,
                `- Harmony Score: ‚â•${systemState.harmony_threshold}% (Current: ${systemState.harmony_score}%)`,
                `- Open Issues: ‚â§20 (Current: ${systemState.active_work.open_issues})`,
                `- Open PRs: ‚â§10 (Current: ${systemState.active_work.open_prs})`,
                `- Cross-space efficiency: ‚â•90%`,
                ``,
                `---`,
                `*This issue was created by MotherSpace Orchestrator v${systemState.spaces.motherspace.version}*`,
                `*All spaces must work in harmony while maintaining functionality, security, and efficiency*`,
                ``,
                `**üéØ MotherSpace Signature:** \`HARMONY-${systemState.harmony_score}-${Date.now()}\``
              ].join('\n');
              
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['motherspace', 'orchestration', 'task-delegation', 'automated', 'priority-high'],
                assignees: ['HANSKMIEL']
              });
              
              console.log(`üéØ Created MotherSpace delegation issue #${issue.data.number}`);
              
              // Create sub-issues for each space-specific task
              for (const task of taskSequence.filter(t => t.space !== 'motherspace')) {
                const subTitle = `${task.space === 'daughter' ? 'üë©‚Äçüíª Daughter' : 'üîó IntegrationManager'} - Phase ${task.phase} Task ${task.order}`;
                const subBody = [
                  `# ${task.space.charAt(0).toUpperCase() + task.space.slice(1)} Space Task`,
                  ``,
                  `**Parent Issue:** #${issue.data.number}`,
                  `**Phase:** ${task.phase}`,
                  `**Execution Order:** ${task.order}`,
                  `**Space:** ${task.space}`,
                  `**Estimated Duration:** ${task.estimated_duration}`,
                  ``,
                  task.space === 'daughter' ? [
                    `## üë©‚Äçüíª Daughter Space UI/UX Analysis`,
                    ``,
                    `**Target Issue:** #${task.task.issue_number} - ${task.task.title}`,
                    `**Analysis Type:** ${task.task.analysis_type}`,
                    `**Priority Level:** ${task.task.priority}`,
                    ``,
                    `### Required Analysis:`,
                    `- [ ] Visual appeal assessment with screenshots`,
                    `- [ ] User experience workflow analysis`,
                    `- [ ] Data import/export workflow evaluation`,
                    `- [ ] User feedback mechanism review`,
                    `- [ ] Workability enhancement recommendations`,
                    ``,
                    `### Deliverables:`,
                    `- [ ] Comprehensive UI/UX analysis report`,
                    `- [ ] Visual mockups or improvement suggestions`,
                    `- [ ] User workflow optimization plan`,
                    `- [ ] Integration requirements for MotherSpace`,
                    ``,
                    `### Communication Protocol:`,
                    `- Report all findings as comments on parent issue #${issue.data.number}`,
                    `- Include screenshots for visual improvements`,
                    `- Tag MotherSpace for coordination needs`,
                    `- Create "Daughter-Integration Manager [Date Time]" issues for major integration needs`
                  ].join('\n') : [
                    `## üîó IntegrationManager Space Module Development`,
                    ``,
                    `**Target Issue:** #${task.task.issue_number} - ${task.task.title}`,
                    `**Integration Type:** ${task.task.integration_type}`,
                    `**Priority Level:** ${task.task.priority}`,
                    ``,
                    `### Required Development:`,
                    `- [ ] Modules repository setup and initialization`,
                    `- [ ] Integration module design and development`,
                    `- [ ] API connection establishment`,
                    `- [ ] Cross-profession adaptability analysis`,
                    `- [ ] External system compatibility testing`,
                    ``,
                    `### Deliverables:`,
                    `- [ ] Functional integration module`,
                    `- [ ] API documentation and examples`,
                    `- [ ] Cross-profession adaptation guidelines`,
                    `- [ ] Integration testing results`,
                    ``,
                    `### Communication Protocol:`,
                    `- Report progress on parent issue #${issue.data.number}`,
                    `- Update MotherSpace on cross-repo changes`,
                    `- Coordinate with Daughter space for UI integrations`,
                    `- Maintain Modules repository synchronization`
                  ].join('\n'),
                  ``,
                  `---`,
                  `*This task is orchestrated by MotherSpace and must maintain harmony with all other spaces*`
                ].join('\n');
                
                const subIssue = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: subTitle,
                  body: subBody,
                  labels: [task.space, 'motherspace-delegated', 'sub-task', task.task.priority || 'medium'],
                  assignees: ['HANSKMIEL']
                });
                
                console.log(`  ‚îî‚îÄ Created ${task.space} sub-issue #${subIssue.data.number}`);
              }
            }
            
            core.setOutput('delegation_completed', true);
            core.setOutput('tasks_delegated', taskSequence.length);

      - name: Harmony Optimization and Continuous Monitoring
        id: harmony_optimization
        if: ${{ always() }}
        uses: actions/github-script@v7
        with:
          script: |
            const systemState = JSON.parse('${{ steps.motherspace_init.outputs.system_state }}');
            
            console.log('üîÑ MotherSpace continuous harmony monitoring activated...');
            
            // Generate harmony report
            const harmonyReport = {
              timestamp: new Date().toISOString(),
              current_score: systemState.harmony_score,
              target_score: parseInt('${{ env.HARMONY_THRESHOLD }}'),
              status: systemState.harmony_score >= parseInt('${{ env.HARMONY_THRESHOLD }}') ? 'optimal' : 'requires_attention',
              factors: systemState.harmony_factors,
              recommendations: []
            };
            
            // Add optimization recommendations
            if (systemState.harmony_factors.space_health < 0.8) {
              harmonyReport.recommendations.push({
                category: 'space_health',
                priority: 'high',
                action: 'Update and optimize space documentation files',
                impact: 'Improves AI assistance and development efficiency'
              });
            }
            
            if (systemState.active_work.open_issues > 20) {
              harmonyReport.recommendations.push({
                category: 'issue_management',
                priority: 'medium',
                action: 'Triage and close stale issues, delegate active ones',
                impact: 'Reduces cognitive load and improves focus'
              });
            }
            
            if (systemState.active_work.delegation_candidates.length > 5) {
              harmonyReport.recommendations.push({
                category: 'delegation',
                priority: 'medium',
                action: 'Activate Daughter and IntegrationManager spaces for specialized tasks',
                impact: 'Distributes workload and improves specialized handling'
              });
            }
            
            // Save harmony report
            const reportPath = `reports/harmony/motherspace_harmony_${new Date().toISOString().split('T')[0]}.json`;
            require('fs').writeFileSync(reportPath, JSON.stringify(harmonyReport, null, 2));
            
            console.log(`üìä Harmony Report Generated: ${harmonyReport.status.toUpperCase()}`);
            console.log(`   Current Score: ${harmonyReport.current_score}%`);
            console.log(`   Recommendations: ${harmonyReport.recommendations.length}`);
            
            return harmonyReport;

      - name: Create MotherSpace Status Report
        if: ${{ always() }}
        uses: actions/github-script@v7
        with:
          script: |
            const systemState = JSON.parse('${{ steps.motherspace_init.outputs.system_state }}');
            const delegationCompleted = '${{ steps.task_delegation.outputs.delegation_completed }}' === 'true';
            const tasksDelegated = '${{ steps.task_delegation.outputs.tasks_delegated }}' || '0';
            const issueAnalysis = '${{ steps.issue_management.outputs.issue_analysis }}' ? JSON.parse('${{ steps.issue_management.outputs.issue_analysis }}') : null;
            const operationResults = '${{ steps.execute_operations.outputs.operation_results }}' ? JSON.parse('${{ steps.execute_operations.outputs.operation_results }}') : null;
            
            console.log('üìã Creating MotherSpace operational status report...');
            
            // Create status comment on trigger issue/PR if applicable
            let statusMessage = [
              `## üéØ MotherSpace Orchestrator Status Report`,
              ``,
              `**Operational Time:** ${new Date().toISOString()}`,
              `**Trigger:** ${context.eventName}`,
              `**Version:** v${{ env.MOTHERSPACE_VERSION }}`,
              ``,
              `### System Harmony Analysis`,
              `- **Current Score:** ${systemState.harmony_score}% (Target: ‚â•${{ env.HARMONY_THRESHOLD }}%)`,
              `- **Status:** ${systemState.needs_intervention ? '‚ö†Ô∏è Requires Intervention' : '‚úÖ Optimal Harmony'}`,
              `- **Active Issues:** ${systemState.active_work.open_issues}`,
              `- **Active PRs:** ${systemState.active_work.open_prs}`,
              `- **Delegation Candidates:** ${systemState.active_work.delegation_candidates.length}`,
              ``,
              `### Space Status`,
              `- **MotherSpace:** üéØ Active and Orchestrating`,
              `- **Daughter Space:** üë©‚Äçüíª ${systemState.spaces.daughter.status}`,
              `- **IntegrationManager:** üîó ${systemState.spaces.integration_manager.status}`,
              ``,
              delegationCompleted ? [
                `### Task Delegation Results`,
                `- **Tasks Delegated:** ${tasksDelegated}`,
                `- **Spaces Activated:** Multiple`,
                `- **Chronological Order:** Established`,
                `- **Quality Checks:** Enabled`,
                `- **Security Level:** ${{ env.SECURITY_LEVEL }}`,
                ``
              ].join('\n') : '',
              issueAnalysis ? [
                `### Issue Management Results`,
                `- **Automated Issues Analyzed:** ${issueAnalysis.duplicates.length + issueAnalysis.mergeable.length + issueAnalysis.routine_tasks.length}`,
                operationResults ? `- **Duplicates Removed:** ${operationResults.duplicates_removed.length}` : '',
                operationResults ? `- **Issues Merged:** ${operationResults.issues_merged.length}` : '',
                operationResults ? `- **Tasks Delegated to Copilot:** ${operationResults.routine_tasks_delegated.length}` : '',
                `- **PR Safety Checks:** ‚úÖ All operations verified safe`,
                `- **Development Protocols:** ‚úÖ Maintained throughout process`,
                ``
              ].join('\n') : '',
              `### Next Actions`,
              systemState.needs_intervention ? [
                `- üîÑ Monitor delegated task execution`,
                `- üìä Track harmony score improvements`,
                `- üõ°Ô∏è Ensure quality and security standards`,
                `- üéØ Coordinate cross-space communication`,
                operationResults && operationResults.routine_tasks_delegated.length > 0 ? `- ü§ñ Monitor Copilot-delegated routine tasks` : '',
                operationResults && operationResults.issues_merged.length > 0 ? `- üîÑ Track unified issue progress` : ''
              ].filter(Boolean).join('\n') : [
                `- ‚úÖ System operating optimally`,
                `- üîÑ Continue monitoring for harmony`,
                `- üìà Maintain current efficiency levels`,
                `- üéØ Ready for new task coordination`,
                issueAnalysis && issueAnalysis.routine_tasks.length > 0 ? `- ü§ñ ${issueAnalysis.routine_tasks.length} routine tasks ready for Copilot delegation` : ''
              ].filter(Boolean).join('\n'),
              ``,
              `---`,
              `*MotherSpace ensures all spaces work in harmony without compromising functionality, security, or efficiency*`
            ].join('\n');
            
            console.log('üéØ MotherSpace Orchestrator cycle completed successfully');
            console.log(`   Status: ${systemState.needs_intervention ? 'Intervention Mode' : 'Harmony Mode'}`);
            console.log(`   Next check: ${context.eventName === 'schedule' ? 'In 2 hours' : 'Event-triggered'}`);

      - name: Complete MotherSpace Safety Operation
        if: ${{ always() && steps.safety_init.outputs.safety_initialized == 'true' }}
        run: |
          echo "üõ°Ô∏è Completing MotherSpace safety operation..."
          
          # Complete the safety operation
          python scripts/motherspace_safety.py --check "orchestrator_run" --actor "${{ github.actor || 'github-actions' }}"
          
          # Cleanup old safety data (keep last 7 days)
          python scripts/motherspace_safety.py --cleanup
          
          echo "‚úÖ MotherSpace safety operation completed"